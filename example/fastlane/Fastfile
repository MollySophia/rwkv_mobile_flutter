lane :all do
  change_analysis_options()
  dart_fix()
  change_analysis_options()
  increase_build_number()
  generate_icon()
  generate_splash()
  # ğŸ”¥ iOS
  # puts "ğŸ”¥ğŸ”¥ğŸ”¥ Start building iOS app for TestFlight External ğŸ”¥ğŸ”¥ğŸ”¥"
  # ios_beta_external()
  # ğŸ”¥ Android APK, pgyer
  puts "ğŸ”¥ğŸ”¥ğŸ”¥ Start building Android APK for pgyer ğŸ”¥ğŸ”¥ğŸ”¥"
  android_pgyer()

  git_reset()
end

lane :dart_fix do
  sh "cd ..;dart fix --apply;cd fastlane"
end

lane :generate_icon do
  sh "cd ..;flutter pub run flutter_launcher_icons:main;cd fastlane"
end

lane :generate_splash do
  sh "cd ..;flutter pub run flutter_native_splash:create;cd fastlane"
end

lane :git_reset do
  sh "git add .;git reset --hard;git clean -fd"
end

lane :change_app_name do
  # TODO: @halo
end

lane :change_app_icon do
  # TODO: @halo
end

lane :change_app_id do
  # TODO: @halo
end

lane :change_analysis_options do
  raw_change_analysis_options()
end

lane :increase_build_number do
  new_build_number = increase_build_version()
  git_add(path: ".")
  git_commit(
    path: ".",
    message: "_",
  )
  # è¿™ä¸ªä¸€å®šè¦è°ƒç”¨å—?
  # å¯èƒ½åœ¨è¿œç«¯è§¦å‘ CI/CD æ˜¯æ›´å¥½çš„é€‰æ‹©
  # push_to_git_remote()
end

lane :ios_beta_external do
  run_flutter_build_ipa()
  build_app(
    project: "./ios/Runner.xcodeproj",
    skip_build_archive: true,
    archive_path: "./build/ios/archive/Runner.xcarchive",
  )
  upload_to_testflight(
    skip_submission: true,
    distribute_external: true,
    changelog: "Bug fixes and UI improvements",
    groups: "External",
    localized_build_info: {
      "default": {
        whats_new: "Bug fixes and UI improvements",
      },
      "zh-Hans": {
        whats_new: "ä¿®å¤å·²çŸ¥é—®é¢˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒ",
      },
    },
  )
end

lane :android_pgyer do
  run_flutter_build_apk()
  pgyer(
    api_key: "8d0497fc24901e6b22c8f272d04791bb",
    apk: "./build/app/outputs/flutter-apk/app-release.apk",
  )
end
